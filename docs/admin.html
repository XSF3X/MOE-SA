<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إدارة المستخدمين</title>

<style>
    body {
        font-family: "Tahoma", sans-serif;
        background: #0e1325;
        margin: 0;
        padding: 0;
        color: #fff;
    }
    .container {
        width: 90%;
        max-width: 900px;
        margin: 40px auto;
    }
    h1 {
        margin-bottom: 25px;
    }
    .box {
        background: #111a2f;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    input, select {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: 8px;
        border: none;
        outline: none;
        background: #1a2438;
        color: #fff;
        font-size: 16px;
    }
    button {
        padding: 10px 18px;
        background: #0cd48a;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        color: #fff;
        font-size: 16px;
        margin-top: 15px;
    }
    .danger {
        background: #d43f3f;
    }
    table {
        width: 100%;
        text-align: center;
        background: #162033;
        border-radius: 12px;
        margin-top: 15px;
    }
    table th, table td {
        padding: 12px;
        border-bottom: 1px solid #222c44;
    }
</style>
</head>

<body>

<div class="container">
    <button onclick="window.location.href='index.html'" 
            style="background:#4a566e; margin-bottom:20px;">
        ⬅ العودة للصفحة الرئيسية
    </button>

    <h1>إدارة المستخدمين</h1>

    <div class="box">
        <h2>إضافة مستخدم</h2>

        <input id="newUser" placeholder="اسم المستخدم">
        <input id="newPass" placeholder="كلمة المرور">
        
        <select id="newRole">
            <option value="teacher">معلّم</option>
            <option value="admin">مدير</option>
        </select>

        <button onclick="addUser()">إضافة</button>
    </div>

    <div class="box">
        <h2>قائمة المستخدمين</h2>

        <table id="usersTable">
            <tr>
                <th>اسم المستخدم</th>
                <th>الدور</th>
                <th>تحكم</th>
            </tr>
        </table>
    </div>
</div>

<script>


const user = JSON.parse(sessionStorage.getItem("user"));
if(!user || user.role !== "admin"){
    window.location.href = "login.html";
}

    
const API = "https://moe-users.snh-saud.workers.dev/";

/* تحميل المستخدمين */
async function loadUsers() {
    try {
        const res = await fetch(API + "?get=1");
        const data = await res.json();

        if (!data.success) {
            alert("فشل التحميل");
            return;
        }

        const table = document.getElementById("usersTable");
        table.innerHTML = `
            <tr>
                <th>اسم المستخدم</th>
                <th>الدور</th>
                <th>تحكم</th>
            </tr>
        `;

        data.users.forEach(u => {
            table.innerHTML += `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.role}</td>
                    <td>
                        <button class="danger" onclick="deleteUser('${u.username}')">حذف</button>
                    </td>
                </tr>
            `;
        });

    } catch (e) {
        alert("خطأ في تحميل البيانات");
    }
}

/* إضافة مستخدم */
async function addUser() {
    const username = document.getElementById("newUser").value.trim().toLowerCase();
    const password = document.getElementById("newPass").value.trim();
    const role = document.getElementById("newRole").value;

    if (!username || !password) {
        alert("يرجى تعبئة جميع الحقول");
        return;
    }

    const res = await fetch(API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password, role })
    });

    const data = await res.json();

    if (!data.success) {
        alert(data.error || "فشل الإضافة");
        return;
    }

    loadUsers();
}

/* حذف مستخدم */
async function deleteUser(username) {
    if (!confirm("هل أنت متأكد من الحذف؟")) return;

    const res = await fetch(API, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
    });

    const data = await res.json();

    if (!data.success) {
        alert("فشل الحذف");
        return;
    }

    loadUsers();
}

loadUsers();
</script>

</body>
</html>

