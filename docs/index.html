<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø¹Ù„Ù… - ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ù„Ù€ QR</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "Cairo", sans-serif;
      background: #0d1117;
      color: #fff;
    }

    header {
      background: #111;
      padding: 14px 20px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      border-bottom: 1px solid #222;
    }

    .container {
      width: 92%;
      max-width: 1100px;
      margin: 25px auto;
    }

    .criteria-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 15px;
      margin-top: 25px;
    }

    .crit-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 14px;
      padding: 16px;
    }

    .crit-title {
      font-size: 18px;
      color: #4cc9f0;
      margin-bottom: 6px;
      font-weight: bold;
    }

    .crit-count {
      font-size: 13px;
      opacity: 0.7;
      margin-bottom: 12px;
    }

    input[type="file"] {
      display: none;
    }

    .btn {
      background: #2389ff;
      border: none;
      padding: 10px 14px;
      color: white;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
      margin-top: 8px;
      font-weight: bold;
    }

    .btn:hover {
      background: #1b6fd1;
    }

    .actions {
      margin-top: 25px;
      text-align: center;
    }

    #btn-generate {
      background: #00b7ff;
      padding: 14px 24px;
      font-size: 20px;
      border-radius: 14px;
      font-weight: bold;
    }

    #btn-generate:hover {
      background: #009ad6;
    }

    .qr-section {
      margin-top: 40px;
      display: none;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .qr-item {
      background: #111;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }

    .qr-item-title {
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .qr-item-url {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 5px;
      word-break: break-all;
      direction: ltr;
    }

    /* Popup */
    .popup-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .popup {
      background: #161b22;
      padding: 20px;
      border-radius: 14px;
      width: 320px;
      border: 1px solid #30363d;
    }

    .popup h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }

    .popup input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #30363d;
      background: #0d1117;
      color: #fff;
      font-size: 14px;
    }

    .popup-actions {
      text-align: right;
      margin-top: 14px;
    }

    .btn-popup {
      background: #00aaff;
      border: none;
      padding: 10px 14px;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<header>ğŸ“ Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… â€“ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª Ùˆ QR</header>

<div class="container">

  <div id="criteria-grid" class="criteria-grid"></div>

  <div class="actions">
  <button id="btn-generate">ğŸš€ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª Ùˆ QR</button>
  <br><br>
  <button id="btn-export-pptx">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PowerPoint</button>
</div>


  <div id="qr-section" class="qr-section">
    <h2>Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</h2>
    <div id="qr-grid" class="qr-grid"></div>
  </div>
</div>

<!-- Popup -->
<div id="teacherPopup" class="popup-backdrop">
  <div class="popup">
    <h3>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…</h3>
    <input id="teacherNameInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§â€¦" />
    <div class="popup-actions">
      <button class="btn-popup" onclick="confirmTeacherName()">ØªØ£ÙƒÙŠØ¯</button>
    </div>
  </div>
</div>
<script>
/* ============================
   Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
============================ */

const GITHUB_PAGES_BASE = "https://xsf3x.github.io/MOE-SA/";   // Ø¨Ø¯ÙˆÙ† docs
const WORKER_URL        = "https://moe-uploader.snh-saud.workers.dev/"; // Ø§Ù„Ø±ÙØ¹

// Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±
const CRITERIA = [
  { id: 1,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„" },
  { id: 2,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ" },
  { id: 3,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«" },
  { id: 4,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹" },
  { id: 5,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø³" },
  { id: 6,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¯Ø³" },
  { id: 7,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ø¹" },
  { id: 8,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù…Ù†" },
  { id: 9,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ§Ø³Ø¹" },
  { id: 10, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø´Ø±" },
  { id: 11, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±" },
  { id: 12, title: "Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰" }
];

const state = {
  teacherName: "",
  teacherFolder: "",
  criteriaFiles: {},  // id -> array of File
  pages: {}           // id -> { url, qr }
};

/* ============================
   Ø¥Ù†Ø´Ø§Ø¡ slug Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…
   Ù…Ø«Ø§Ù„: "Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ" â†’ "saud-alshareef"
============================ */

function slugify(text) {
  return text
    .toString()
    .normalize("NFD")
    .replace(/[\u064B-\u0652]/g, "") // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
    .replace(/[\u0600-\u06FF]/g, "") // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ù…Ù„Ø©
    .replace(/[^a-zA-Z0-9]+/g, "-")  // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒÙ„ Ø§Ù„Ø±Ù…ÙˆØ² ÙˆØ§Ù„ÙØ±Ø§ØºØ§Øª Ø¨Ø´Ø±Ø·Ø©
    .replace(/-+/g, "-")             // Ù„Ø§ Ù†ÙƒØ±Ø± Ø§Ù„Ø´Ø±Ø·Ø©
    .replace(/^-|-$/g, "")           // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø·Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©
    .toLowerCase();
}

/* ============================
   Ø¨Ù†Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª (UI) Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±
============================ */

function buildCards() {
  const grid = document.getElementById("criteria-grid");

  CRITERIA.forEach(c => {
    const card = document.createElement("div");
    card.className = "crit-card";

    card.innerHTML = `
      <div>
        <div class="crit-title">${c.title}</div>
        <div class="crit-count" id="count-${c.id}">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±</div>
      </div>

      <button class="btn" type="button">ğŸ“ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±</button>
      <input id="file-${c.id}" type="file" accept="image/*" multiple>
    `;

    grid.appendChild(card);

    const btn = card.querySelector("button");
    const input = card.querySelector("input");
    const countEl = document.getElementById(`count-${c.id}`);

    btn.addEventListener("click", () => input.click());

    input.addEventListener("change", e => {
      const files = Array.from(e.target.files || []);
      state.criteriaFiles[c.id] = files;

      if (!files.length) {
        countEl.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±";
      } else {
        countEl.textContent = `${files.length} ØµÙˆØ±Ø©`;
      }
    });
  });
}

/* ============================
   Ù‚Ø±Ø§Ø¡Ø© ØµÙˆØ±Ø© â†’ Base64 DataURL
============================ */

function readAsDataURL(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}
/* ============================
   ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø© HTML Ù„ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø±
============================ */

function buildCriterionHTML(teacherName, critTitle, imagesDataUrls) {

  const imagesHTML = imagesDataUrls.map((src, i) => `
    <div style="max-width:900px;margin:20px auto;">
      <img src="${src}" style="width:100%;border-radius:12px;box-shadow:0 0 8px rgba(0,0,0,0.15);">
    </div>
  `).join("");

  return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>${critTitle} - ${teacherName}</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      line-height: 1.8;
    }
    h1 { margin-bottom: 6px; }
    h2 { margin-top: 0; color: #666; font-size: 16px; }
  </style>
</head>
<body>
  <h1>${critTitle}</h1>
  <h2>${teacherName}</h2>

  ${imagesHTML}

</body>
</html>
  `;
}

/* ============================
   Ø±ÙØ¹ Ù…Ù„Ù HTML Ø¥Ù„Ù‰ GitHub
   Ø¹Ø¨Ø± Cloudflare Worker
============================ */

async function githubUpload(path, content) {

  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ path, content })
  });

  const text = await res.text();
  let data;

  try { data = JSON.parse(text); }
  catch { data = text; }

  if (!res.ok || (data && data.ok === false)) {
    console.error("Upload error:", data);
    throw new Error("GitHub upload failed: " + res.status);
  }

  return data;
}

/* ============================
   ØªÙˆÙ„ÙŠØ¯ QR (Canvas â†’ Base64)
============================ */

function generateQR(url) {
  return new Promise(resolve => {
    const wrapper = document.createElement("div");
    const el = document.createElement("div");
    wrapper.appendChild(el);

    new QRCode(el, {
      text: url,
      width: 200,
      height: 200
    });

    setTimeout(() => {
      const canvas = wrapper.querySelector("canvas");
      const dataUrl = canvas ? canvas.toDataURL("image/png") : "";
      resolve(dataUrl);
    }, 220);
  });
}
/* ============================
   Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±
============================ */

async function generateAll() {

  // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ù†Ø§Ùƒ ØµÙˆØ±
  const any = Object.values(state.criteriaFiles).some(arr => arr && arr.length);
  if (!any) {
    alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ù„Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±.");
    return;
  }

  // Ù„Ùˆ Ù…Ø§ ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… â€” Ù†Ø¸Ù‡Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
  if (!state.teacherName.trim()) {
    openTeacherPopup();
    return;
  }

  // ØªØµÙÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¹Ù„Ù…
  state.teacherFolder = slugify(state.teacherName);
  if (!state.teacherFolder) {
    alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… ØºÙŠØ± ØµØ§Ù„Ø­. Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­.");
    return;
  }

  const qrSection = document.getElementById("qr-section");
  const qrGrid = document.getElementById("qr-grid");
  qrGrid.innerHTML = "";
  qrSection.style.display = "none";

  alert("Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±â€¦ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.");

  try {

    for (const crit of CRITERIA) {

      const files = state.criteriaFiles[crit.id] || [];
      if (!files.length) continue;

      // ØªØ­ÙˆÙŠÙ„ ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Base64
      const dataUrls = [];
      for (const f of files) {
        const d = await readAsDataURL(f);
        dataUrls.push(d);
      }

      // Ø¨Ù†Ø§Ø¡ ØµÙØ­Ø© HTML
      const html = buildCriterionHTML(state.teacherName, crit.title, dataUrls);

      // ğŸ”¥ Ù…Ø³Ø§Ø± Ø§Ù„Ø±ÙØ¹: Ø¯Ø§Ø®Ù„ docs/Ù…Ø¬Ù„Ø¯_Ø§Ù„Ù…Ø¹Ù„Ù…
      const path = `docs/${state.teacherFolder}/criterion-${crit.id}.html`;

      await githubUpload(path, html);

      // ğŸ”¥ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶: Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© docs
      const publicUrl = `${GITHUB_PAGES_BASE}${state.teacherFolder}/criterion-${crit.id}.html`;

      // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ QR
      const qrData = await generateQR(publicUrl);
      state.pages[crit.id] = { url: publicUrl, qr: qrData };

      // Ø¹Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©
      const item = document.createElement("div");
      item.className = "qr-item";

      item.innerHTML = `
        <div class="qr-item-title">${crit.title}</div>
        <img src="${qrData}" width="150" height="150" />
        <div class="qr-item-url">${publicUrl}</div>
      `;

      qrGrid.appendChild(item);
    }

    qrSection.style.display = "block";
    alert("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª Ùˆ QR Ø¨Ù†Ø¬Ø§Ø­ âœ”");

  } catch (e) {
    console.error(e);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª:\n" + e.message);
  }
}

/* ============================
   Ø¥Ø¯Ø§Ø±Ø© Popup Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…
============================ */

function openTeacherPopup() {
  document.getElementById("teacherPopup").style.display = "flex";
  document.getElementById("teacherNameInput").focus();
}

function closeTeacherPopup() {
  document.getElementById("teacherPopup").style.display = "none";
}

function confirmTeacherName() {
  const val = document.getElementById("teacherNameInput").value.trim();
  if (!val) return;

  state.teacherName = val;
  closeTeacherPopup();
  generateAll(); // Ù†ÙƒÙ…Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
}

function dataURLToUint8Array(dataURL) {
  const base64 = dataURL.split(",")[1];
  const binary = atob(base64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  return bytes;
}

async function exportPptx() {
  if (!Object.keys(state.pages).length) {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ QR Ù…ÙˆÙ„Ù‘Ø¯ Ø¨Ø¹Ø¯. Ø£ÙˆÙ„Ø§Ù‹ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª Ùˆ QR.");
    return;
  }

  if (!state.teacherFolder) {
    // ÙÙŠ Ø­Ø§Ù„ Ù…Ø§ Ø§Ù†Ø­ÙØ¸ Ù…Ù† Ù‚Ø¨Ù„
    if (!state.teacherName.trim()) {
      openTeacherPopup();
      return;
    }
    state.teacherFolder = slugify(state.teacherName);
  }

  try {
    // 1) ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù‚Ø§Ù„Ø¨ template.pptx
    const resp = await fetch("./template.pptx");
    if (!resp.ok) {
      alert("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ template.pptx. ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¬Ø§Ù†Ø¨ index.html ÙÙŠ GitHub.");
      return;
    }
    const buf = await resp.arrayBuffer();
    const zip = await JSZip.loadAsync(buf);

    const startSlide = 8; // Ø£ÙˆÙ„ Ø´Ø±ÙŠØ­Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ±

    // 2) Ù„ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø± ÙÙŠÙ‡ QR Ù†Ø¶ÙŠÙ ØµÙˆØ±Ø© ÙˆÙ†Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø´Ø±ÙŠØ­Ø©
    for (const crit of CRITERIA) {
      const page = state.pages[crit.id];
      if (!page || !page.qr) continue;

      // Ø±Ù‚Ù… Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø¯Ø§Ø®Ù„ PPTX (slide8 -> criterion1, slide9 -> criterion2, ...)
      const slideNo = startSlide + (crit.id - 1);
      const slidePath = `ppt/slides/slide${slideNo}.xml`;
      const relsPath  = `ppt/slides/_rels/slide${slideNo}.xml.rels`;

      const slideFile = zip.file(slidePath);
      const relsFile  = zip.file(relsPath);

      if (!slideFile || !relsFile) {
        console.warn("Ù„Ù… Ø£Ø¬Ø¯ Ù…Ù„Ù Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª:", slidePath, relsPath);
        continue;
      }

      // 2.1 Ø­ÙØ¸ ØµÙˆØ±Ø© QR Ø¯Ø§Ø®Ù„ ppt/media
      const imgName = `qr-crit-${crit.id}.png`;
      const imgPath = `ppt/media/${imgName}`;
      const imgBytes = dataURLToUint8Array(page.qr);
      zip.file(imgPath, imgBytes);

      // 2.2 Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù‚Ø© image ÙÙŠ slideX.xml.rels
      let relsXml = await relsFile.async("string");
      const relId = `rIdQR${crit.id}`;
      const relTag = `<Relationship Id="${relId}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="../media/${imgName}"/>`;
      relsXml = relsXml.replace("</Relationships>", `${relTag}</Relationships>`);
      zip.file(relsPath, relsXml);

      // 2.3 Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± <p:pic> Ø¯Ø§Ø®Ù„ Ø§Ù„Ø´Ø±ÙŠØ­Ø©
      let slideXml = await slideFile.async("string");

      // Ø­Ø¬Ù… ÙˆÙ…ÙƒØ§Ù† Ø§Ù„Ù€ QR (Ø«Ø§Ø¨ØªØŒ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ùˆ Ø­Ø§Ø¨ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…ÙƒØ§Ù†)
      const x = 2500000; // Ø¥Ø²Ø§Ø­Ø© X
      const y = 1200000; // Ø¥Ø²Ø§Ø­Ø© Y
      const cx = 3000000; // Ø§Ù„Ø¹Ø±Ø¶
      const cy = 3000000; // Ø§Ù„Ø§Ø±ØªÙØ§Ø¹

      const picXml = `
      <p:pic>
        <p:nvPicPr>
          <p:cNvPr id="100${crit.id}" name="QR ${crit.id}"/>
          <p:cNvPicPr/>
          <p:nvPr/>
        </p:nvPicPr>
        <p:blipFill>
          <a:blip r:embed="${relId}"/>
          <a:stretch>
            <a:fillRect/>
          </a:stretch>
        </p:blipFill>
        <p:spPr>
          <a:xfrm>
            <a:off x="${x}" y="${y}"/>
            <a:ext cx="${cx}" cy="${cy}"/>
          </a:xfrm>
          <a:prstGeom prst="rect">
            <a:avLst/>
          </a:prstGeom>
        </p:spPr>
      </p:pic>
      `;

      // Ù†Ø¶ÙŠÙ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø¹Ù†ØµØ± spTree (Ø´Ø¬Ø±Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„)
      slideXml = slideXml.replace("</p:spTree>", `${picXml}</p:spTree>`);
      zip.file(slidePath, slideXml);
    }

    // 3) ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ù„Ù ÙˆØ­ÙØ¸Ù‡
    const outBlob = await zip.generateAsync({ type: "blob" });
    const fileName = (state.teacherFolder || "teacher") + ".pptx";
    saveAs(outBlob, fileName);

    alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PowerPoint Ø¨Ù†Ø¬Ø§Ø­ âœ…");

  } catch (e) {
    console.error(e);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¨ÙˆØ±Ø¨ÙˆÙŠÙ†Øª:\n" + e.message);
  }
}

/* ============================
   Ø§Ù„ØªØ´ØºÙŠÙ„
============================ */

document.getElementById("btn-generate").addEventListener("click", () => {
  if (!state.teacherName.trim()) {
    openTeacherPopup();
  } else {
    generateAll();
  }
});

document.getElementById("btn-export-pptx").addEventListener("click", exportPptx);

// Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
buildCards();


</script>
</body>
</html>
