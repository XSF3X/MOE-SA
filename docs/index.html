<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø¹Ù„Ù… - ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ù„Ù€ QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 35%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      backdrop-filter: blur(10px);
      padding: 10px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-badge {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 30%, #38bdf8, #0ea5e9 45%, #0369a1 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #0f172a;
    }

    .brand-title {
      font-weight: 700;
      font-size: 16px;
    }

    .logout-btn {
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.6);
      background: transparent;
      color: #fecaca;
      padding: 5px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .logout-btn:hover {
      background: rgba(248, 113, 113, 0.16);
    }

    main {
      padding: 22px 14px 32px;
      max-width: 1150px;
      margin: 0 auto;
    }

    .panel {
      background: radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%);
      border-radius: 18px;
      padding: 20px 16px 22px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .panel-header {
      text-align: center;
      margin-bottom: 18px;
    }

    .panel-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .panel-subtitle {
      font-size: 13px;
      color: #9ca3af;
    }

    .criteria-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 14px;
    }

    .crit-card {
      background: radial-gradient(circle at top, #0f172a 0%, #020617 55%);
      border-radius: 14px;
      padding: 14px 12px 12px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow:
        0 12px 25px rgba(15, 23, 42, 0.8),
        inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 110px;
    }

    .crit-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .crit-count {
      font-size: 12px;
      color: #94a3b8;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.16s ease, background 0.16s ease;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none !important;
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.8);
      font-size: 12px;
      margin-top: 8px;
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 0.8);
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #0f172a;
      font-weight: 600;
      box-shadow: 0 10px 24px rgba(56, 189, 248, 0.5);
    }

    .btn-primary:hover {
      box-shadow: 0 12px 28px rgba(56, 189, 248, 0.6);
    }

    .actions {
      display: flex;
      justify-content: center;
      margin-top: 22px;
    }

    .qr-section {
      margin-top: 22px;
      padding: 16px 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: #020617;
      display: none;
    }

    .qr-section h3 {
      margin: 0 0 8px;
      font-size: 15px;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .qr-item {
      background: #020617;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      padding: 8px 6px 10px;
      text-align: center;
      font-size: 12px;
    }

    .qr-item-title {
      margin-bottom: 4px;
      color: #e5e7eb;
      font-weight: 600;
      font-size: 12px;
    }

    .qr-item-url {
      font-size: 10px;
      margin-top: 4px;
      direction: ltr;
      text-align: center;
      color: #9ca3af;
      word-break: break-all;
    }

    .status-text {
      margin-top: 6px;
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      min-height: 16px;
    }

    /* Popup */
    .popup-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .popup {
      background: #020617;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      width: 320px;
      max-width: 92vw;
      padding: 16px 16px 14px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .popup h3 {
      margin: 0 0 10px;
      font-size: 15px;
    }

    .popup label {
      font-size: 12px;
      margin-bottom: 4px;
      display: block;
      color: #e5e7eb;
    }

    .popup input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: #020617;
      color: #e5e7eb;
      font-family: inherit;
      font-size: 13px;
    }

    .popup-actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    @media (max-width: 640px) {
      main { padding-inline: 10px; }
      .panel { padding-inline: 11px; }
      .criteria-grid { grid-template-columns: 1fr; }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

<header>
  <div class="brand">
    <div class="brand-badge">Ù…</div>
    <div class="brand-title">Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø¹Ù„Ù…</div>
  </div>
  <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</header>

<main>
  <section class="panel">
    <div class="panel-header">
      <div class="panel-title">ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø§Øª HTML ÙˆØ±ÙˆØ§Ø¨Ø· QR Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ±</div>
      <div class="panel-subtitle">Ø§Ø®ØªØ± ØµÙˆØ± Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ Ù„ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø±ØŒ Ø«Ù… Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯</div>
    </div>

    <div id="criteria-grid" class="criteria-grid"></div>

    <div class="status-text" id="status-text"></div>

    <div class="actions">
      <button id="btn-generate" class="btn btn-primary">
        ğŸ§© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ù„Ù€ QR
      </button>
    </div>

    <div id="qr-section" class="qr-section">
      <h3>Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ±ÙˆØ§Ø¨Ø· Ø§Ù„Ù€ QR</h3>
      <div id="qr-grid" class="qr-grid"></div>
    </div>
  </section>
</main>

<!-- Popup Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… -->
<div id="teacherPopup" class="popup-backdrop">
  <div class="popup">
    <h3>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
    <label for="teacherNameInput">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙƒÙ…Ø§ ØªØ±ØºØ¨ Ø£Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª:</label>
    <input id="teacherNameInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£. Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ" />
    <div class="popup-actions">
      <button class="btn btn-secondary" onclick="closeTeacherPopup()">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary" onclick="confirmTeacherName()">ØªØ£ÙƒÙŠØ¯</button>
    </div>
  </div>
</div>

<script>
  // =========================
  // Ø«ÙˆØ§Ø¨Øª
  // =========================
  const GITHUB_PAGES_BASE = "https://xsf3x.github.io/MOE-SA/";   // Ø¨Ø¯ÙˆÙ† docs
  const TEACHER_FOLDER    = "TEACHER-SA";                        // Ø«Ø§Ø¨Øª
  const WORKER_URL        = "https://moe-uploader.snh-saud.workers.dev/";

  const CRITERIA = [
    { id: 1,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„" },
    { id: 2,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ" },
    { id: 3,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«" },
    { id: 4,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹" },
    { id: 5,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø³" },
    { id: 6,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¯Ø³" },
    { id: 7,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ø¹" },
    { id: 8,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù…Ù†" },
    { id: 9,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ§Ø³Ø¹" },
    { id: 10, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø´Ø±" },
    { id: 11, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±" },
    { id: 12, title: "Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰" }
  ];

  const state = {
    teacherName: "",
    criteriaFiles: {}, // id -> File[]
    pages: {}          // id -> { url, qr }
  };

  // =========================
  // ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø³ÙŠØ·Ø©
  // =========================
  function logout() {
    localStorage.removeItem("loggedInUser");
    location.href = "login.html";
  }

  function setStatus(msg) {
    document.getElementById("status-text").textContent = msg || "";
  }

  function buildCards() {
    const grid = document.getElementById("criteria-grid");

    CRITERIA.forEach(c => {
      const card = document.createElement("div");
      card.className = "crit-card";

      card.innerHTML = `
        <div>
          <div class="crit-title">${c.title}</div>
          <div class="crit-count" id="count-${c.id}">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±</div>
        </div>
        <div>
          <button class="btn btn-secondary" type="button">
            ğŸ“ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±
          </button>
          <input id="file-${c.id}" type="file" accept="image/*" multiple style="display:none" />
        </div>
      `;

      grid.appendChild(card);

      const btn    = card.querySelector("button");
      const input  = card.querySelector("input");
      const countEl = document.getElementById(`count-${c.id}`);

      btn.addEventListener("click", () => input.click());

      input.addEventListener("change", ev => {
        const files = Array.from(ev.target.files || []);
        state.criteriaFiles[c.id] = files;
        if (!files.length) {
          countEl.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±";
        } else {
          countEl.textContent = `${files.length} ØµÙˆØ±Ø©`;
        }
      });
    });
  }

  // =========================
  // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
  // =========================
  function readAsDataURL(file) {
    return new Promise(resolve => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.readAsDataURL(file);
    });
  }

  async function githubUpload(path, content) {
    // Ù‡Ù†Ø§ Ù†Ø±Ø³Ù„ Ø¥Ù„Ù‰ Cloudflare Worker
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ path, content })
    });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { data = text; }

    if (!res.ok || (data && data.ok === false)) {
      console.error("Worker/GitHub error:", res.status, data);
      throw new Error("Upload failed: " + res.status);
    }
    return data;
  }

  function buildCriterionHTML(teacherName, critTitle, imagesDataUrls) {
    const imgsHtml = imagesDataUrls.map((src, i) =>
      `<div style="max-width:900px;margin:10px auto;">
         <img src="${src}" alt="ØµÙˆØ±Ø© ${i + 1}" style="max-width:100%;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,0.2);">
       </div>`
    ).join("\n");

    return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>${critTitle} - ${teacherName}</title>
  <style>
    body { font-family: 'Cairo', Tahoma, Arial, sans-serif; margin:0; padding:20px; background:#f3f4f6; }
    h1 { margin-bottom:4px; }
    h2 { margin-top:0; color:#4b5563; font-size:16px; }
  </style>
</head>
<body>
  <h1>${critTitle}</h1>
  <h2>${teacherName}</h2>
  ${imgsHtml}
</body>
</html>`;
  }

  function generateQR(url) {
    return new Promise(resolve => {
      const container = document.createElement("div");
      const div = document.createElement("div");
      container.appendChild(div);

      new QRCode(div, { text: url, width: 200, height: 200 });

      setTimeout(() => {
        const canvas = container.querySelector("canvas");
        const dataUrl = canvas ? canvas.toDataURL("image/png") : "";
        resolve(dataUrl);
      }, 250);
    });
  }

  // =========================
  // Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  // =========================
  async function generateAll() {
    // ØªØ£ÙƒØ¯ ÙÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¹ÙŠØ§Ø± ÙˆØ§Ø­Ø¯ ÙÙŠÙ‡ ØµÙˆØ±
    const hasAny = Object.values(state.criteriaFiles).some(arr => arr && arr.length);
    if (!hasAny) {
      alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±.");
      return;
    }

    const name = state.teacherName.trim();
    if (!name) {
      openTeacherPopup();
      return;
    }

    const qrSection = document.getElementById("qr-section");
    const qrGrid    = document.getElementById("qr-grid");
    qrGrid.innerHTML = "";
    qrSection.style.display = "none";

    setStatus("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØ±ÙØ¹ Ø§Ù„ØµÙØ­Ø§ØªØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...");

    try {
      for (const crit of CRITERIA) {
        const files = state.criteriaFiles[crit.id] || [];
        if (!files.length) continue;

        // Ù†Ø­ÙˆÙ„ Ø§Ù„ØµÙˆØ± base64
        const dataUrls = [];
        for (const f of files) {
          const d = await readAsDataURL(f);
          dataUrls.push(d);
        }

        // ğŸ”¥ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù ÙÙŠ GitHub: Ø¯Ø§Ø®Ù„ docs
        const path = `docs/${TEACHER_FOLDER}/criterion-${crit.id}.html`;

        const html = buildCriterionHTML(state.teacherName, crit.title, dataUrls);
        await githubUpload(path, html);

        // ğŸ”¥ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙŠ ÙŠØ±ÙˆØ­ Ù„Ù„Ù…Ø¹Ù„Ù… / QR: Ø¨Ø¯ÙˆÙ† ÙƒÙ„Ù…Ø© docs
        const publicUrl = `${GITHUB_PAGES_BASE}${TEACHER_FOLDER}/criterion-${crit.id}.html`;

        const qrData = await generateQR(publicUrl);

        state.pages[crit.id] = { url: publicUrl, qr: qrData };

        const item = document.createElement("div");
        item.className = "qr-item";
        item.innerHTML = `
          <div class="qr-item-title">${crit.title}</div>
          <div><img src="${qrData}" alt="QR" width="150" height="150"></div>
          <div class="qr-item-url">${publicUrl}</div>
        `;
        qrGrid.appendChild(item);
      }

      qrSection.style.display = "block";
      setStatus("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ù„Ù€ QR Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (err) {
      console.error(err);
      setStatus("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹ Ø£Ùˆ Ø§Ù„ØªÙˆÙ„ÙŠØ¯. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Console Ù„Ù„ØªÙØ§ØµÙŠÙ„.");
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙØ­Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ† ÙˆØ§Ù„Ù€ Worker.");
    }
  }

  // =========================
  // Popup Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…
  // =========================
  function openTeacherPopup() {
    document.getElementById("teacherPopup").style.display = "flex";
    document.getElementById("teacherNameInput").focus();
  }

  function closeTeacherPopup() {
    document.getElementById("teacherPopup").style.display = "none";
  }

  function confirmTeacherName() {
    const val = document.getElementById("teacherNameInput").value.trim();
    if (!val) return;
    state.teacherName = val;
    closeTeacherPopup();
    generateAll(); // Ù†ÙƒÙ…Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…
  }

  // Ø²Ø± Ø§Ù„ØªÙˆÙ„ÙŠØ¯
  document.getElementById("btn-generate").addEventListener("click", () => {
    if (!state.teacherName.trim()) {
      openTeacherPopup();
    } else {
      generateAll();
    }
  });

  // Ù†Ø¨Ù†ÙŠ Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  buildCards();
</script>

</body>
</html>
