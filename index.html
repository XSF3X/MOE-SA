<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø¹Ù„Ù… - ØªÙˆÙ„ÙŠØ¯ QR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Ø§Ù„Ø®Ø· -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Cairo", Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 35%, #0f172a 100%);
            color: #0f172a;
            min-height: 100vh;
            direction: rtl;
        }

        header {
            background: rgba(15, 23, 42, 0.92);
            color: #e5e7eb;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }

        header .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 18px;
        }

        header .logo span {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            background: radial-gradient(circle at 30% 30%, #38bdf8, #0ea5e9 40%, #0369a1 100%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        header .logout-btn {
            background: transparent;
            border-radius: 999px;
            border: 1px solid rgba(248, 113, 113, 0.5);
            color: #fecaca;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        header .logout-btn:hover {
            background: rgba(248, 113, 113, 0.15);
            border-color: rgba(248, 113, 113, 0.9);
        }

        main {
            padding: 26px 18px 36px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .page-card {
            background: rgba(15, 23, 42, 0.96);
            border-radius: 18px;
            padding: 22px 20px 24px;
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.65),
                0 0 0 1px rgba(148, 163, 184, 0.3);
            color: #e5e7eb;
        }

        .page-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #9ca3af;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 14px;
        }

        .card {
            background: radial-gradient(circle at top, #1f2937 0%, #020617 55%);
            border-radius: 14px;
            padding: 16px 14px 14px;
            border: 1px solid rgba(148, 163, 184, 0.55);
            box-shadow:
                0 12px 24px rgba(15, 23, 42, 0.6),
                inset 0 0 0 1px rgba(15, 23, 42, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 10px;
            min-height: 120px;
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .card-count {
            font-size: 13px;
            color: #9ca3af;
        }

        .btn {
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 13px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            color: #0f172a;
            box-shadow: 0 10px 22px rgba(56, 189, 248, 0.4);
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(56, 189, 248, 0.5);
        }

        .btn-secondary {
            background: rgba(15, 23, 42, 0.85);
            color: #e5e7eb;
            border: 1px solid rgba(148, 163, 184, 0.8);
        }

        .btn-secondary:hover {
            background: rgba(15, 23, 42, 0.7);
        }

        .actions-row {
            margin-top: 24px;
            display: flex;
            justify-content: center;
        }

        .actions-row button {
            min-width: 200px;
        }

        .qr-section {
            margin-top: 26px;
            background: radial-gradient(circle at top, #020617 0%, #020617 40%, #020617 100%);
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            padding: 18px 14px 16px;
            display: none;
        }

        .qr-section h3 {
            margin: 0 0 10px;
            font-size: 16px;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .qr-item {
            background: rgba(15, 23, 42, 0.85);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            border: 1px solid rgba(55, 65, 81, 0.8);
        }

        .qr-item img {
            margin-top: 6px;
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… */
        .popup-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }

        .popup {
            background: #020617;
            border-radius: 14px;
            padding: 18px 18px 16px;
            border: 1px solid rgba(148, 163, 184, 0.8);
            width: 320px;
            max-width: 90vw;
            color: #e5e7eb;
            box-shadow:
                0 18px 40px rgba(15, 23, 42, 0.9),
                0 0 0 1px rgba(15, 23, 42, 0.9);
        }

        .popup h3 {
            margin: 0 0 8px;
            font-size: 16px;
        }

        .popup label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .popup input {
            width: 100%;
            padding: 8px 9px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.9);
            background: #020617;
            color: #e5e7eb;
            font-family: inherit;
            font-size: 13px;
        }

        .popup-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        @media (max-width: 640px) {
            main {
                padding: 18px 10px 26px;
            }

            .page-card {
                padding: 18px 14px 20px;
            }

            .criteria-grid {
                grid-template-columns: 1fr;
            }

            header {
                padding-inline: 14px;
            }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <span>Ù…</span>
        <div>Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø¹Ù„Ù…</div>
    </div>
    <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</header>

<main>
    <div class="page-card">
        <div class="page-header">
            <div class="page-title">ØªÙˆÙ„ÙŠØ¯ ÙˆØ±Ø¨Ø· QR Ù„Ù„ØµÙØ­Ø§Øª</div>
            <div class="page-subtitle">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ Ù„ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø±</div>
        </div>

        <div id="criteria-grid" class="criteria-grid">
            <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙØ¨Ù†Ù‰ Ø¨Ø§Ù„Ù€ JS -->
        </div>

        <div class="actions-row">
            <button id="btn-generate" class="btn btn-primary">
                ğŸ§© ØªÙˆÙ„ÙŠØ¯ Ù…Ù„ÙØ§Øª HTML Ùˆ QR
            </button>
        </div>

        <div id="qr-section" class="qr-section">
            <h3>Ø±ÙˆØ§Ø¨Ø· ÙˆØµÙØ­Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± (QR)</h3>
            <div id="qr-grid" class="qr-grid"></div>
        </div>
    </div>
</main>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… -->
<div id="teacherPopup" class="popup-backdrop">
    <div class="popup">
        <h3>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
        <label for="teacherNameInput">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… ÙƒÙ…Ø§ ØªØ±ÙŠØ¯ Ø¸Ù‡ÙˆØ±Ù‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª:</label>
        <input id="teacherNameInput" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£. Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ">
        <div class="popup-actions">
            <button class="btn btn-secondary" onclick="closeTeacherPopup()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn btn-primary" onclick="confirmTeacherName()">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>
</div>

<script>
const GITHUB_PAGES_BASE = "https://xsf3x.github.io/MOE-SA/";

const CRITERIA = [
  { id: 1,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„" },
  { id: 2,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ" },
  { id: 3,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«" },
  { id: 4,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹" },
  { id: 5,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø³" },
  { id: 6,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¯Ø³" },
  { id: 7,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ø¹" },
  { id: 8,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù…Ù†" },
  { id: 9,  title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ§Ø³Ø¹" },
  { id: 10, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø´Ø±" },
  { id: 11, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±" },
  { id: 12, title: "Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰" }
];

const state = {
  teacherName: "",
  criteriaFiles: {},   // id -> File[]
  pages: {},           // id -> { url, qr }
};

function logout() {
  localStorage.removeItem("loggedInUser");
  location.href = "login.html";
}

function buildCards() {
  const grid = document.getElementById("criteria-grid");

  CRITERIA.forEach(c => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="card-title">${c.title}</div>
      <div class="card-count" id="count-${c.id}">0 ØµÙˆØ±Ø©</div>
      <label class="btn btn-secondary">
        Ø§Ø®ØªØ± ØµÙˆØ±
        <input id="file-${c.id}" type="file" accept="image/*" multiple style="display:none" />
      </label>
    `;

    grid.appendChild(card);

    document.getElementById(`file-${c.id}`).addEventListener("change", e => {
      const files = Array.from(e.target.files);
      state.criteriaFiles[c.id] = files;
      document.getElementById(`count-${c.id}`).textContent = `${files.length} ØµÙˆØ±Ø©`;
    });
  });
}

function readAsDataURL(file) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.readAsDataURL(file);
  });
}

// =======================
//  Cloudflare Worker API
// =======================
async function githubUpload(path, content) {
  const res = await fetch("https://moe-uploader.snh-saud.workers.dev/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ path, content })
  });

  const data = await res.json().catch(() => ({}));

  if (!res.ok || (data.status && data.status >= 300)) {
    console.error("Worker upload error:", res.status, data);
    throw new Error(data.error || (data.github && data.github.message) || "Upload failed");
  }

  return data;
}

// ØªÙˆÙ„ÙŠØ¯ QR Ù„ØµÙˆØ±Ø© base64
function generateQR(url) {
  return new Promise(resolve => {
    const div = document.createElement("div");
    new QRCode(div, { text: url, width: 200, height: 200 });

    setTimeout(() => {
      const canvas = div.querySelector("canvas");
      resolve(canvas.toDataURL("image/png"));
    }, 300);
  });
}

// HTML Ø¬Ø§Ù‡Ø² Ù„ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø±
function buildCriterionHTML(teacherSafe, critTitle, imagesData) {
  const imagesHtml = imagesData.map((src, i) =>
    `<div style="margin:10px auto; max-width:900px;">
       <img src="${src}" alt="ØµÙˆØ±Ø© ${i + 1}" style="max-width:100%; border-radius:8px; box-shadow:0 0 4px rgba(0,0,0,0.2); margin:6px 0;">
     </div>`
  ).join("\n");

  return `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>${critTitle} - ${teacherSafe}</title>
  <style>
    body { font-family: 'Cairo', Tahoma, Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; text-align:center; direction:rtl; }
    h1 { margin-bottom:4px; }
    h2 { margin-top:0; color:#555; font-size:16px; }
  </style>
</head>
<body>
  <h1>${critTitle}</h1>
  <h2>${teacherSafe}</h2>
  ${imagesHtml}
</body>
</html>`;
}

// Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
async function generate() {
  const qrGrid = document.getElementById("qr-grid");
  qrGrid.innerHTML = "";
  state.pages = {};

  const name = state.teacherName.trim();
  if (!name) {
    alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  const teacherSafe = encodeURIComponent(name);

  for (const crit of CRITERIA) {
    const files = state.criteriaFiles[crit.id] || [];
    if (!files.length) continue;

    // Ù†Ø­ÙˆÙ„ ÙƒÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ base64
    const dataUrls = [];
    for (const f of files) {
      const dataUrl = await readAsDataURL(f);
      dataUrls.push(dataUrl);
    }

    const path = `pages/${teacherSafe}/criterion-${crit.id}.html`;
    const htmlContent = buildCriterionHTML(name, crit.title, dataUrls);

    // Ø±ÙØ¹ ØµÙØ­Ø© HTML Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù€ Worker
    await githubUpload(path, htmlContent);

    const fullUrl = GITHUB_PAGES_BASE + path;
    const qrData = await generateQR(fullUrl);

    state.pages[crit.id] = { url: fullUrl, qr: qrData };

    const d = document.createElement("div");
    d.className = "qr-item";
    d.innerHTML = `<div>${crit.title}</div><img src="${qrData}" width="150"><div style="font-size:11px;word-break:break-all;">${fullUrl}</div>`;
    qrGrid.appendChild(d);
  }

  document.getElementById("qr-section").style.display = "block";
}

// ===== Ù†Ø§ÙØ°Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… =====
function openTeacherPopup() {
  document.getElementById("teacherPopup").style.display = "flex";
  document.getElementById("teacherNameInput").focus();
}

function closeTeacherPopup() {
  document.getElementById("teacherPopup").style.display = "none";
}

function confirmTeacherName() {
  state.teacherName = document.getElementById("teacherNameInput").value.trim();
  if (!state.teacherName) return;
  closeTeacherPopup();
  generate();
}

document.getElementById("btn-generate").onclick = openTeacherPopup;

// Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
buildCards();
</script>

</body>
</html>
