<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…Ù„Ù Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø¹Ù„Ù… - ØªÙˆÙ„ÙŠØ¯ QR</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  body {
    font-family: "Cairo", sans-serif;
    background: #f5f6fa;
    margin: 0;
    padding: 0;
  }
  header {
    background: #2c3e50;
    padding: 15px;
    color: #fff;
    display: flex;
    justify-content: space-between;
  }
  .container {
    padding: 20px;
    max-width: 1250px;
    margin: auto;
  }
  #criteria-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
    gap: 16px;
  }
  .card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    border: 1px solid #dcdcdc;
  }
  .card-title {
    font-size: 18px;
    font-weight: bold;
    color: #2c3e50;
  }
  .card-count {
    font-size: 14px;
    color: #555;
  }
  .btn {
    background: #3498db;
    color: white;
    padding: 10px 14px;
    border-radius: 8px;
    margin-top: 8px;
    border: none;
    cursor: pointer;
  }
  .btn-ghost {
    background: #eee;
    color: #111;
    padding: 8px 12px;
    margin-top: 6px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }
  #qr-section {
    margin-top: 25px;
    padding: 15px;
    background: #fff;
    border-radius: 12px;
    border: 1px solid #ccc;
    display: none;
  }
  #qr-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-top: 16px;
  }
  .qr-item {
    text-align: center;
    padding: 12px;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 10px;
  }
  .card-status {
    margin-top: 8px;
    font-size: 14px;
    color: #555;
  }
  .badge-ok {
    color: green;
    font-weight: bold;
  }
  .badge-warn {
    color: #c0392b;
    font-weight: bold;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

</head>
<body>

<header>
  <div>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="teacher-username"></span></div>
  <button onclick="logout()" style="background:#e74c3c;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</header>

<div class="container">

  <h2>ØªÙˆÙ„ÙŠØ¯ QR ÙˆØ±Ø¨Ø· Ø§Ù„ØµÙØ­Ø§Øª</h2>
  <p id="global-status">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø§Ù„Ø´ÙˆØ§Ù‡Ø¯ Ù„ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø±</p>

  <div id="criteria-grid"></div>

  <button id="btn-generate" class="btn">ğŸ”— ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ù Ø§Ù„Ù€ PPTX</button>

  <div id="qr-section">
    <h3>Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ùˆ QR</h3>
    <div id="qr-grid"></div>
  </div>
</div>
<!-- Popup -->
<div id="teacherPopup" style="
    display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4);
    justify-content:center; align-items:center;">
  <div style="background:white;padding:20px;border-radius:12px; width:300px;">
    <h3>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
    <input id="teacherNameInput" type="text" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <br><br>
    <button onclick="confirmTeacherName()" class="btn">ØªØ£ÙƒÙŠØ¯</button>
    <button onclick="closeTeacherPopup()" class="btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<script>
/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub Pages */
const GITHUB_PAGES_BASE = "https://xsf3x.github.io/MOE-SA/";

/* Ù‚Ø§Ù„Ø¨ PPTX */
const PPTX_TEMPLATE_URL = "template.pptx";

/* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± */
const CRITERIA = [
  { id: 1, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„", subtitle: "Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ©" },
  { id: 2, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ", subtitle: "Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ Ø§Ù„Ù…Ù‡Ù†ÙŠ" },
  { id: 3, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«", subtitle: "Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±" },
  { id: 4, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹", subtitle: "Ø¥Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³" },
  { id: 5, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø³", subtitle: "ØªØ­Ø³ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ¹Ù„Ù…ÙŠÙ†" },
  { id: 6, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¯Ø³", subtitle: "Ø®Ø·Ø© Ø§Ù„ØªØ¹Ù„Ù…" },
  { id: 7, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¨Ø¹", subtitle: "Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©" },
  { id: 8, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù…Ù†", subtitle: "ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©" },
  { id: 9, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„ØªØ§Ø³Ø¹", subtitle: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙÙŠØ©" },
  { id: 10, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø¹Ø§Ø´Ø±", subtitle: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬" },
  { id: 11, title: "Ø§Ù„Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±", subtitle: "Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…" },
  { id: 12, title: "Ù…Ù†Ø¬Ø²Ø§Øª Ø£Ø®Ø±Ù‰", subtitle: "Ù…Ù†Ø¬Ø²Ø§Øª Ø¹Ø§Ù…Ø©" }
];

const state = {
  criteriaFiles: {},
  pages: {},
  teacherName: "",
  pptxBuffer: null
};

function logout() {
  localStorage.removeItem("loggedInUser");
  location.href = "login.html";
}

/* Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± */
function buildCards() {
  const grid = document.getElementById("criteria-grid");

  CRITERIA.forEach(c => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="card-title">${c.title}</div>
      <div class="card-count" id="count-${c.id}">0 ØµÙˆØ±Ø©</div>
      <div class="card-status" id="status-${c.id}"></div>
      <button class="btn-ghost" onclick="document.getElementById('file-${c.id}').click()">Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±</button>
      <input type="file" id="file-${c.id}" multiple accept="image/*" style="display:none">
    `;

    grid.appendChild(card);

    document.getElementById(`file-${c.id}`).addEventListener("change", e => {
      const files = Array.from(e.target.files);
      state.criteriaFiles[c.id] = files;
      document.getElementById(`count-${c.id}`).textContent = `${files.length} ØµÙˆØ±Ø©`;
      document.getElementById(`status-${c.id}`).textContent = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹";
    });
  });
}

/* Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù */
function readAsDataURL(file) {
  return new Promise(res => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.readAsDataURL(file);
  });
}
/* Ø±ÙØ¹ HTML Ø¹Ø¨Ø± Cloudflare Worker */
async function githubUpload(path, content) {
  const res = await fetch("https://moe-uploader.snh-saud.workers.dev/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ path, content })
  });

  const data = await res.json();

  if (!res.ok) {
    console.error("Upload error:", data);
    throw new Error("Upload failed");
  }

  return data;
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ */
async function loadTemplate() {
  const res = await fetch(PPTX_TEMPLATE_URL);
  state.pptxBuffer = await res.arrayBuffer();
}

/* Ø¨Ù†Ø§Ø¡ HTML */
function buildPageHTML(teacher, crit, imgs) {
  return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>${crit.title}</title>
</head>
<body>
<h1>${crit.title}</h1>
<h3>${crit.subtitle}</h3>
<p>Ø§Ù„Ù…Ø¹Ù„Ù…: ${teacher}</p>
${imgs.map((i, n) => `<h4>Ø§Ù„ØµÙˆØ±Ø© ${n+1}</h4><img src="${i}" width="100%">`).join("")}
</body>
</html>`;
}

/* ØªØ¹Ø¯ÙŠÙ„ PPTX */
async function buildPPTX() {
  const zip = await JSZip.loadAsync(state.pptxBuffer);

  const slide1 = "ppt/slides/slide1.xml";
  let xml = await zip.file(slide1).async("string");
  xml = xml.replace(/âˆ‘/g, state.teacherName);
  zip.file(slide1, xml);

  for (const cid in state.pages) {
    zip.file(`ppt/media/qr${cid}.png`, state.pages[cid].bin, { binary: true });
  }

  return zip.generateAsync({ type: "blob" });
}

/* Ø§Ù„Ø´ØºÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
async function generate() {
  if (!state.teacherName) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…");

  const active = Object.keys(state.criteriaFiles);

  for (const id of active) {
    const crit = CRITERIA.find(c => c.id == id);
    const files = state.criteriaFiles[id];

    const urls = [];
    for (const f of files) urls.push(await readAsDataURL(f));

    const html = buildPageHTML(state.teacherName, crit, urls);

    const folder = state.teacherName.replace(/ /g, "_");
    const path = `pages/${folder}/criterion-${id}.html`;

    await githubUpload(path, html);

    const fullUrl = `${GITHUB_PAGES_BASE}pages/${folder}/criterion-${id}.html`;

    const qrData = await generateQR(fullUrl);
    const bin = Uint8Array.from(atob(qrData.split(",")[1]), c => c.charCodeAt(0));

    state.pages[id] = { url: fullUrl, qr: qrData, bin };

    document.getElementById("qr-section").style.display = "block";
    const d = document.createElement("div");
    d.className = "qr-item";
    d.innerHTML = `<div>${crit.title}</div><img src="${qrData}" width="150"><div>${fullUrl}</div>`;
    document.getElementById("qr-grid").appendChild(d);
  }

  const blob = await buildPPTX();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "Ù…Ù„Ù-Ø§Ù†Ø¬Ø§Ø²-Ø§Ù„Ù…Ø¹Ù„Ù….pptx";
  a.click();
}

/* ØªÙˆÙ„ÙŠØ¯ QR */
function generateQR(url) {
  return new Promise(resolve => {
    const div = document.createElement("div");
    const qr = new QRCode(div, { text: url, width: 200, height: 200 });

    setTimeout(() => {
      const canvas = div.querySelector("canvas");
      resolve(canvas.toDataURL("image/png"));
    }, 400);
  });
}
/* popup */
function openTeacherPopup() {
  document.getElementById("teacherPopup").style.display = "flex";
}
function closeTeacherPopup() {
  document.getElementById("teacherPopup").style.display = "none";
}
function confirmTeacherName() {
  state.teacherName = document.getElementById("teacherNameInput").value.trim();
  if (!state.teacherName) return;
  closeTeacherPopup();
  generate();
}

document.getElementById("btn-generate").onclick = openTeacherPopup;

/* ØªØ´ØºÙŠÙ„ */
buildCards();
loadTemplate();
</script>

</body>
</html>
